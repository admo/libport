#! /bin/sh

# Bootstrap Urbi module buildsystem.
# Input: local.ac files in subdirectories, optonally local.mk files.
# Output: ./modules.ac to include in your configure.ac
#         ./modules.mk to include in your Makefile.am
# local.ac expected content: autoconf code that sets urbi_enable_module=false
#   to disable the module. Empty is fine.
# local.mk is autogenerated if not present, using all recursively found source
#   files in the module directory
#

>modules.mk
>modules.ac

buildauxdir=$(dirname $0)

log()
{
  echo "$@"
}

# Look for directories containing a module.ac
for moduledir in $(find * -type d); do
  acfile=$moduledir/local.ac
  modulename=$(basename $moduledir)
  modulenormname=$(echo $modulename | tr '-' '_')
  modulenormdir=$(echo $moduledir | tr '-' '_')
  if ! test -f $acfile; then continue; fi

  # Check if this is a full or a skeleton module.ac
  if grep -q URBI_MODULE $acfile; then
    log "Appending $acfile"
    echo "m4_include($acfile)" >> modules.ac
  else
    log "Generating and appending $acfile.auto"
    echo "URBI_MODULE([$modulenormname], [" > $acfile.auto
    cat $acfile >> $acfile.auto
    echo "])" >> $acfile.auto
    echo "m4_include($acfile.auto)" >> modules.ac
  fi

  # Generate local.mk if it is not there
  if ! test -f "$moduledir/local.mk"; then
    log "Generating and appending $moduledir/local.mk.auto"
    modulesources=$(find "$moduledir" \
	-name '*.cc'      \
	-or -name '*.cpp' \
	-or -name '*.hh'  \
	-or -name '*.c'   \
	-or -name '*.hxx' | xargs echo)

    sed -e  "s/@MODULENAME@/$modulename/g" \
        -e  "s/@MODULENORMNAME@/$modulenormname/g" \
        -e  "s/@MODULEDIR@/$moduledir/g"   \
	-e  "s/@MODULENORMDIR@/$modulenormdir/g"   \
	-e  "s!@MODULESOURCES@!$modulesources!g" \
      "$buildauxdir/module.mk.skel" > "$moduledir/local.mk.auto"
    echo "include $moduledir/local.mk.auto" >> modules.mk
  else
    log "Appending $moduledir/local.mk"
    echo "include $moduledir/local.mk" >> modules.mk
  fi
done
