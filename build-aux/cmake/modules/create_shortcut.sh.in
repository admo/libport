#! /bin/sh

## Variables
: ${DEBUG=0}
: ${TYPE="install"}
DESKTOP_FILE=@DATA_DIR@/@STGZ_XDG_FILENAME@.desktop
DESKTOP_ICON=@DATA_DIR@/@STGZ_XDG_FILENAME@.png
MIME_XML=@DATA_DIR@/@STGZ_XDG_FILENAME@.xml
MIME=@STGZ_SHORTCUTS_MIME@

## Debug
if test $DEBUG -ge 1; then
  set -x
  export XDG_UTILS_DEBUG_LEVEL=$(($DEBUG - 1))
fi

## Init, create desktop file
cat > $DESKTOP_FILE << EOF
[Desktop Entry]
Version=1.0
Encoding=UTF-8
Name=@PROJECT_LONGNAME@
Type=Application
Icon=@CPACK_PACKAGE_VENDOR@-@CPACK_PACKAGE_NAME@
TryExec=$(pwd)/@BINARIES_DIR@/@STGZ_SHORTCUTS_CMD@
Exec=$(pwd)/@BINARIES_DIR@/@STGZ_SHORTCUTS_CMD@ @STGZ_SHORTCUTS_CMD_ARGS@
Categories=Education;Science;Robotics
MimeType=$MIME;
EOF

cat > $MIME_XML << EOF
<?xml version="1.0"?>
<mime-info xmlns='http://www.freedesktop.org/standards/shared-mime-info'>
  <mime-type type="$MIME">
    <comment>@STGZ_SHORTCUTS_DESCRIPTION@</comment>
EOF
if test "x@STGZ_SHORTCUTS_DOCTYPE@" != x; then
  cat >> $MIME_XML << EOF
    <magic priority="50">
      <match type="string" offset="0" value="@STGZ_SHORTCUTS_DOCTYPE@" />
    </magic>
EOF
fi
cat >> $MIME_XML << EOF
    <glob pattern="*.@STGZ_SHORTCUTS_FILE_EXTENSION@"/>
  </mime-type>
</mime-info>
EOF

## Generic fctions
warn()
{
  echo 1>&2 "$@"
}

run()
{
  local desc="$1"
  shift
  $@ 2>&1 > /dev/null
  local res=$?
  if test $res -ne 0; then
    if test $res -eq 127; then
      warn "Not making $desc (missing $1)"
    else
      warn "$1: unknown error.  The $desc may not have been installed."
    fi
  fi
  return $res
}

ask()
{
  ## Check if enabled for this app
  if ! $(eval echo '$'$1); then
    return
  fi

  echo "Do you want to $2? [Yn] "
  read line leftover || line="EOF"
  case ${line} in
    n | N)
      eval $1=false;;
    y | Y | "")
      eval $1=true;;
    *)
      warn "Please answer with 'y', 'Y', 'n' or 'N'"
      ask "$1" "$2";;
  esac
}

init_var()
{
  case $2 in
    @* | "" | 0 | "FALSE" | "false" )
      eval $1=false;;
    *)
      eval $1=true;;
  esac
}

## Main code
init_var DESKTOP_ENABLE "@STGZ_SHORTCUTS_DESKTOP@"
init_var MENU_ENABLE "@STGZ_SHORTCUTS_MENU@"
init_var FILE_ASSOC_ENABLE "@STGZ_SHORTCUTS_FILE_EXTENSION@"

if test "x$TYPE" = "xinstall"
then
  ask DESKTOP_ENABLE "create a desktop shortcut"
  ask MENU_ENABLE "create a menu shortcut"
  ask FILE_ASSOC_ENABLE "open .@STGZ_SHORTCUTS_FILE_EXTENSION@ files with @PROJECT_LONGNAME@"
fi

if $DESKTOP_ENABLE && $MENU_ENABLE; then
  run "icon" xdg-icon-resource $TYPE --size 48 $DESKTOP_ICON @STGZ_XDG_FILENAME@
fi
if $DESKTOP_ENABLE; then
  run "Desktop icon" xdg-desktop-icon $TYPE $DESKTOP_FILE
fi
if $MENU_ENABLE; then
  run "menu item" xdg-desktop-menu $TYPE $DESKTOP_FILE
fi

if $FILE_ASSOC_ENABLE; then
  run ".@STGZ_SHORTCUTS_FILE_EXTENSION@ file MIME registration" xdg-mime $TYPE $MIME_XML
  run ".@STGZ_SHORTCUTS_FILE_EXTENSION@ file MIME association" xdg-mime default @STGZ_XDG_FILENAME@.desktop $MIME
fi
